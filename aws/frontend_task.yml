family: "$PROGRAM-$ENV-$PROJECT-frontend"
networkMode: awsvpc
cpu: "256"
memory: "512"
executionRoleArn: "arn:aws:iam::$ACCOUNT_ID:role/power-user-$PROGRAM-$ENV-$PROJECT-ecs-task-execution-role"
taskRoleArn: "arn:aws:iam::$ACCOUNT_ID:role/power-user-$PROGRAM-$ENV-$PROJECT-ecs-task-role"
requiresCompatibilities:
  - FARGATE
containerDefinitions:
  - name: sumologic-firelens
    image: public.ecr.aws/aws-observability/aws-for-fluent-bit:stable
    essential: true
    firelensConfiguration:
      type: fluentbit
      options:
        enable-ecs-log-metadata: "true"

  - name: newrelic-infra
    image: newrelic/nri-ecs:1.9.2
    essential: true
    secrets:
      - name: NRIA_LICENSE_KEY
        valueFrom: "arn:aws:secretsmanager:us-east-1:$ACCOUNT_ID:secret:monitoring/newrelic:api_key::"
    environment:
      - name: NEW_RELIC_HOST
        value: "gov-collector.newrelic.com"
      - name: NEW_RELIC_APP_NAME
        value: "$PROJECT-$ENV-frontend"
      - name: NRIA_IS_FORWARD_ONLY
        value: "true"
      - name: NEW_RELIC_DISTRIBUTED_TRACING_ENABLED
        value: "true"
      - name: NRIA_PASSTHROUGH_ENVIRONMENT
        value: "ECS_CONTAINER_METADATA_URI,ECS_CONTAINER_METADATA_URI_V4,FARGATE"
      - name: FARGATE
        value: "true"
      - name: NRIA_CUSTOM_ATTRIBUTES
        value: "{\"nrDeployMethod\":\"downloadPage\"}"
      - name: NRIA_OVERRIDE_HOST_ROOT
        value: ""

  - name: frontend
    image: "$IMAGE_ID"
    portMappings:
      - containerPort: 80
        hostPort: 80
        protocol: tcp
    essential: true
    secrets:
      - name: NEW_RELIC_LICENSE_KEY
        valueFrom: "arn:aws:secretsmanager:us-east-1:$ACCOUNT_ID:secret:monitoring/newrelic:api_key::"
      - name: REACT_APP_GA_TRACKING_ID
        valueFrom: "arn:aws:secretsmanager:us-east-1:$ACCOUNT_ID:secret:bento/$PROJECT/$ENV:google_id::"
    environment:
      - name: PROJECT
        value: "$PROJECT"
      - name: REACT_APP_FRONTEND_VERSION
        value: "$IMAGE_TAG"
      # - name: REACT_APP_BE_VERSION
      #   value: "$BE_VERSION"
      - name: REACT_APP_BACKEND_API
        value: "https://$DOMAIN_NAME/v1/graphql/"
      - name: REACT_APP_FILE_SERVICE_API
        value: "https://$DOMAIN_NAME/api/files/"
      - name: NEW_RELIC_DISTRIBUTED_TRACING_ENABLED
        value: "true"
      - name: NEW_RELIC_NO_CONFIG_FILE
        value: "true"
      - name: NEW_RELIC_HOST
        value: "gov-collector.newrelic.com"
      - name: NEW_RELIC_LABELS
        value: "Project:$PROJECT;Environment:$ENV"
      - name: NEW_RELIC_APP_NAME
        value: "$PROJECT-$ENV-frontend"
      - name: REACT_APP_AUTH
        value: "true"
      - name: REACT_APP_ABOUT_CONTENT_URL
        value: "$REACT_APP_ABOUT_CONTENT_URL"
      - name: REACT_APP_INTEROP_SERVICE_URL
        value: "https://clinical-$ENV.datacommons.cancer.gov/api/interoperation/"
      - name: NODE_LEVEL_ACCESS
        value: "gov-collector.newrelic.com"
      - name: REACT_APP_BACKEND_GETUSERINFO_API
        value: "https://k9dc.essential-dev.com/fence/login/"
      - name: REACT_APP_LOGIN_URL
        value: "https://$REDIRECT_URL/user/oauth2/authorize?client_id=$DCF_CLIENT_ID&response_type=code&redirect_uri=https://$DOMAIN_NAME/login&scope=openid%20user%20data"
      - name: REACT_APP_AUTH_SERVICE_API
        value: "https://$DOMAIN_NAME/api/auth/"
      # System Info environment variables
      - name: REACT_APP_FILE_SERVICE_VERSION
        value: "{% if $ENV == 'prod' %}https://{{ subdomain }}.{{ domain_name }}/api/files/version{% else %}https://{{ subdomain }}-{{ $ENV }}.{{ domain_name }}/api/files/version{% endif %}"
      - name: REACT_APP_INTEROP_SERVICE_VERSION
        value: "{% if $ENV == 'prod' %}https://{{ subdomain }}.{{ domain_name }}/api/interoperation/version{% else %}https://{{ subdomain }}-{{ $ENV }}.{{ domain_name }}/api/interoperation/version{% endif %}"
      - name: REACT_APP_BACKEND_VERSION
        value: "{% if $ENV == 'prod' %}https://{{ subdomain }}.{{ domain_name }}/version{% else %}https://{{ subdomain }}-{{ $ENV }}.{{ domain_name }}/version{% endif %}"
      - name: REACT_APP_AUTH_SERVICE_VERSION
        value: "{% if $ENV == 'prod' %}https://{{ subdomain }}.{{ domain_name }}/api/auth/version{% else %}https://{{ subdomain }}-{{ $ENV }}.{{ domain_name }}/api/auth/version{% endif %}"
      # React App File Centric Cart Readme
      - name: REACT_APP_FILE_CENTRIC_CART_README
        value: >-
          {% if $ENV == "dev" %}
          https://raw.githubusercontent.com/CBIIT/ctdc-readMe-content/refs/heads/dev/My_Files_Cart_Page_README.md
          {% elif $ENV == "qa" %}
          https://raw.githubusercontent.com/CBIIT/ctdc-readMe-content/refs/heads/qa/My_Files_Cart_Page_README.md
          {% elif $ENV == "stage" %}
          https://raw.githubusercontent.com/CBIIT/ctdc-readMe-content/refs/heads/stage/My_Files_Cart_Page_README.md
          {% elif $ENV == "prod" %}
          https://raw.githubusercontent.com/CBIIT/ctdc-readMe-content/refs/heads/prod/My_Files_Cart_Page_README.md
          {% else %}
          ""
          {% endif %}

    logConfiguration:
      logDriver: awsfirelens
      options:
        Format: json_lines
        Host: "$SUMO_COLLECTOR_ENDPOINT"
        Name: http
        Port: "443"
        Retry_Limit: "2"
        URI: "/receiver/v1/http/$SUMO_COLLECTOR_TOKEN"
        tls: "on"
        tls.verify: "off"
